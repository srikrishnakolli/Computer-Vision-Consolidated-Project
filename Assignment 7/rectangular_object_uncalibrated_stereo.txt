╔════════════════════════════════════════════════════════════════════════════╗
║     UNCALIBRATED STEREO: RECTANGULAR OBJECT SIZE ESTIMATION               ║
╚════════════════════════════════════════════════════════════════════════════╝

═══════════════════════════════════════════════════════════════════════════════
                            PROBLEM DEFINITION
═══════════════════════════════════════════════════════════════════════════════

  GIVEN:
    • Stereo image pair (left and right) from uncalibrated cameras
    • Rectangular object visible in both images
    • Reference object with known dimension L_ref
  
  FIND:
    • Width (W) of the rectangle
    • Height (H) of the rectangle
    • Area (A) of the rectangle

  CONSTRAINTS:
    • No camera calibration available
    • No knowledge of focal length, principal point, or camera baseline


╔════════════════════════════════════════════════════════════════════════════╗
║                        MATHEMATICAL DERIVATION                             ║
╚════════════════════════════════════════════════════════════════════════════╝

┌────────────────────────────────────────────────────────────────────────────┐
│ STEP 1: FUNDAMENTAL MATRIX ESTIMATION                                     │
└────────────────────────────────────────────────────────────────────────────┘

  Epipolar Constraint for corresponding points (x₁, x₂):
  
    ┌─────────────────┐
    │  x₂ᵀ F x₁ = 0   │  ← Fundamental equation
    └─────────────────┘
  
  where x₁ = [u₁, v₁, 1]ᵀ  and  x₂ = [u₂, v₂, 1]ᵀ


  8-POINT ALGORITHM (Normalized):
  
  ① Normalize coordinates:
     ────────────────────
     Transform points so centroid at origin, avg distance = √2
     
     T = [s  0  -s·cₓ]     where s = √2 / avg_dist
         [0  s  -s·cᵧ]
         [0  0    1  ]
     
     x̃₁ = T₁ x₁,  x̃₂ = T₂ x₂

  ② Form constraint matrix A (n × 9):
     ────────────────────────────────
     Each correspondence gives one row:
     
     [u₂u₁, u₂v₁, u₂, v₂u₁, v₂v₁, v₂, u₁, v₁, 1]

  ③ Solve Af = 0 using SVD:
     ─────────────────────
     A = U Σ Vᵀ
     f = last column of V (smallest singular value)

  ④ Reshape to 3×3 and enforce rank 2:
     ──────────────────────────────────
     F̃ = U_F · diag(σ₁, σ₂, 0) · V_Fᵀ

  ⑤ Denormalize:
     ───────────
     ┌──────────────────┐
     │  F = T₂ᵀ F̃ T₁   │  ← Final fundamental matrix
     └──────────────────┘


┌────────────────────────────────────────────────────────────────────────────┐
│ STEP 2: CAMERA PROJECTION MATRICES                                        │
└────────────────────────────────────────────────────────────────────────────┘

  Left Camera (Canonical - world origin):
  ────────────────────────────────────────
  
    P₁ = [I₃ | 0] = [1  0  0  0]
                    [0  1  0  0]
                    [0  0  1  0]


  Right Camera (from Fundamental Matrix):
  ────────────────────────────────────────
  
  ① Find right epipole e₂ (satisfies Fᵀe₂ = 0):
     
     Fᵀ = U Σ Vᵀ  (SVD)
     e₂ = last column of V
     e₂ = e₂ / e₂[2]  (normalize)

  ② Form skew-symmetric matrix:
     
     [e₂]ₓ = [  0     -e₂z    e₂y ]
             [ e₂z      0    -e₂x ]
             [-e₂y    e₂x      0  ]

  ③ Construct P₂:
     
     ┌───────────────────────┐
     │  P₂ = [[e₂]ₓ F | e₂]  │  ← Right projection matrix
     └───────────────────────┘


┌────────────────────────────────────────────────────────────────────────────┐
│ STEP 3: TRIANGULATION (Direct Linear Transform)                           │
└────────────────────────────────────────────────────────────────────────────┘

  For point correspondence (x₁, x₂), find 3D point X such that:
  
    x₁ ≅ P₁ X  and  x₂ ≅ P₂ X


  DLT Formulation:
  ────────────────
  
  From cross product: x × (PX) = 0
  
  This gives 4 independent equations:
  
    u₁(p₁³ᵀX) - (p₁¹ᵀX) = 0
    v₁(p₁³ᵀX) - (p₁²ᵀX) = 0
    u₂(p₂³ᵀX) - (p₂¹ᵀX) = 0
    v₂(p₂³ᵀX) - (p₂²ᵀX) = 0
  
  where pᵢʲᵀ is j-th row of camera matrix Pᵢ


  Matrix Form:
  ────────────
  
    ⎡u₁p₁³ᵀ - p₁¹ᵀ⎤     ⎡X⎤
    ⎢v₁p₁³ᵀ - p₁²ᵀ⎥     ⎢Y⎥
    ⎢u₂p₂³ᵀ - p₂¹ᵀ⎥  ·  ⎢Z⎥  = 0
    ⎣v₂p₂³ᵀ - p₂²ᵀ⎦     ⎣W⎦
  
  Solve via SVD: A = U Σ Vᵀ
  
  X_homogeneous = last column of V
  
  ┌──────────────────────────────────────┐
  │  X₃D = [X/W, Y/W, Z/W]ᵀ              │  ← 3D point (projective!)
  └──────────────────────────────────────┘
  
  ⚠️  This is PROJECTIVE reconstruction - scale is unknown!


┌────────────────────────────────────────────────────────────────────────────┐
│ STEP 4: SCALE RECOVERY (THE CRITICAL STEP!)                               │
└────────────────────────────────────────────────────────────────────────────┘

  Problem: Projective reconstruction only gives relative geometry
  Solution: Use REFERENCE OBJECT with KNOWN DIMENSION


  Procedure:
  ──────────
  
  ① Identify reference points A and B with known distance L_ref
     (e.g., ruler marks 100mm apart, checkerboard square 20mm)
     
     Left:  A₁=(u_A1, v_A1), B₁=(u_B1, v_B1)
     Right: A₂=(u_A2, v_A2), B₂=(u_B2, v_B2)

  ② Triangulate reference points:
     
     X_A = Triangulate(A₁, A₂, P₁, P₂)  using DLT
     X_B = Triangulate(B₁, B₂, P₁, P₂)  using DLT

  ③ Compute reconstructed distance (in projective space):
     
     L_recon = ||X_B - X_A||
     L_recon = √[(X_B-X_A)² + (Y_B-Y_A)² + (Z_B-Z_A)²]

  ④ Calculate scale factor:
     
     ╔═══════════════════════════════╗
     ║  λ = L_ref / L_recon          ║  ← SCALE FACTOR
     ╚═══════════════════════════════╝
     
     This converts projective units to metric units!

  ⑤ Apply to all 3D points:
     
     X_metric = λ · X_projective


┌────────────────────────────────────────────────────────────────────────────┐
│ STEP 5: RECTANGLE CORNER TRIANGULATION                                    │
└────────────────────────────────────────────────────────────────────────────┘

  Rectangle has 4 corners (labeled counter-clockwise):
  
      C₄ ──────────── C₃
      │               │
      │               │  Height (H)
      │               │
      C₁ ──────────── C₂
          Width (W)


  For each corner i = 1, 2, 3, 4:
  ────────────────────────────────
  
  ① Identify in both images:
     Left:  Cᵢ,₁ = (uᵢ₁, vᵢ₁)
     Right: Cᵢ,₂ = (uᵢ₂, vᵢ₂)

  ② Triangulate (projective):
     X̂ᵢ = Triangulate(Cᵢ,₁, Cᵢ,₂, P₁, P₂)

  ③ Apply scale factor:
     ┌─────────────────┐
     │  Xᵢ = λ · X̂ᵢ   │  ← Metric 3D coordinates
     └─────────────────┘

  Result: Four 3D points X₁, X₂, X₃, X₄ in metric units


┌────────────────────────────────────────────────────────────────────────────┐
│ STEP 6: DIMENSION CALCULATION                                             │
└────────────────────────────────────────────────────────────────────────────┘

  WIDTH (bottom and top edges):
  ──────────────────────────────
  
    W_bottom = ||X₂ - X₁|| = √[(X₂-X₁)² + (Y₂-Y₁)² + (Z₂-Z₁)²]
    
    W_top    = ||X₃ - X₄|| = √[(X₃-X₄)² + (Y₃-Y₄)² + (Z₃-Z₄)²]
    
    ┌──────────────────────────────┐
    │  W = (W_bottom + W_top) / 2  │  ← Average for robustness
    └──────────────────────────────┘


  HEIGHT (left and right edges):
  ───────────────────────────────
  
    H_left  = ||X₄ - X₁|| = √[(X₄-X₁)² + (Y₄-Y₁)² + (Z₄-Z₁)²]
    
    H_right = ||X₃ - X₂|| = √[(X₃-X₂)² + (Y₃-Y₂)² + (Z₃-Z₂)²]
    
    ┌──────────────────────────────┐
    │  H = (H_left + H_right) / 2  │  ← Average for robustness
    └──────────────────────────────┘


  AREA:
  ─────
    ┌─────────────┐
    │  A = W × H  │
    └─────────────┘


  VERIFICATION (Diagonals should be equal):
  ─────────────────────────────────────────
  
    D₁ = ||X₃ - X₁||
    D₂ = ||X₄ - X₂||
    
    For perfect rectangle: D₁ ≈ D₂ ≈ √(W² + H²)


╔════════════════════════════════════════════════════════════════════════════╗
║                        COMPLETE ALGORITHM SUMMARY                          ║
╚════════════════════════════════════════════════════════════════════════════╝

INPUT:
  • Stereo pair (left/right images)
  • ≥8 point correspondences
  • 4 rectangle corner points (both images)
  • 2 reference points with known distance L_ref

──────────────────────────────────────────────────────────────────────────────

STEP 1: Estimate F using normalized 8-point algorithm
        ↓
        x₂ᵀ F x₁ = 0  (rank 2)

STEP 2: Compute camera matrices
        ↓
        P₁ = [I|0]
        P₂ = [[e₂]ₓF|e₂]  where Fᵀe₂ = 0

STEP 3: Triangulate reference points (A, B)
        ↓
        X_A, X_B using DLT

STEP 4: Compute scale factor
        ↓
        λ = L_ref / ||X_B - X_A||

STEP 5: Triangulate & scale rectangle corners
        ↓
        X₁ = λ·X̂₁, X₂ = λ·X̂₂, X₃ = λ·X̂₃, X₄ = λ·X̂₄

STEP 6: Calculate dimensions
        ↓
        W = (||X₂-X₁|| + ||X₃-X₄||) / 2
        H = (||X₄-X₁|| + ||X₃-X₂||) / 2
        A = W × H

──────────────────────────────────────────────────────────────────────────────

OUTPUT:
  • Width (W) in units of L_ref
  • Height (H) in units of L_ref  
  • Area (A) in units² of L_ref


╔════════════════════════════════════════════════════════════════════════════╗
║                          NUMERICAL EXAMPLE                                 ║
╚════════════════════════════════════════════════════════════════════════════╝

Given:
──────
  Reference: L_ref = 100 mm (ruler marks)
  Reconstructed reference distance: L_recon = 0.0873 (projective units)
  
  Rectangle corners (projective, after triangulation):
    X̂₁ = (0.0120, 0.0156, 0.0980)
    X̂₂ = (0.0670, 0.0154, 0.0978)
    X̂₃ = (0.0668, 0.0068, 0.0976)
    X̂₄ = (0.0122, 0.0070, 0.0978)


Calculation:
────────────

  ① Scale factor:
     λ = 100 / 0.0873 = 1145.48

  ② Metric coordinates:
     X₁ = 1145.48 × (0.0120, 0.0156, 0.0980) = (13.75, 17.87, 112.26)
     X₂ = 1145.48 × (0.0670, 0.0154, 0.0978) = (76.75, 17.64, 112.03)
     X₃ = 1145.48 × (0.0668, 0.0068, 0.0976) = (76.52,  7.79, 111.80)
     X₄ = 1145.48 × (0.0122, 0.0070, 0.0978) = (13.97,  8.02, 112.03)

  ③ Width:
     W_bottom = ||X₂-X₁|| = √[(76.75-13.75)² + (17.64-17.87)² + (112.03-112.26)²]
              = √[63.00² + 0.05 + 0.05] = 63.00 mm
     
     W_top = ||X₃-X₄|| = √[(76.52-13.97)² + (7.79-8.02)² + (111.80-112.03)²]
           = √[62.55² + 0.05 + 0.05] = 62.56 mm
     
     W = (63.00 + 62.56) / 2 = 62.78 mm

  ④ Height:
     H_left = ||X₄-X₁|| = √[(13.97-13.75)² + (8.02-17.87)² + (112.03-112.26)²]
            = √[0.05 + 97.02 + 0.05] = 9.85 mm
     
     H_right = ||X₃-X₂|| = √[(76.52-76.75)² + (7.79-17.64)² + (111.80-112.03)²]
             = √[0.05 + 97.02 + 0.05] = 9.86 mm
     
     H = (9.85 + 9.86) / 2 = 9.86 mm

  ⑤ Area:
     A = W × H = 62.78 × 9.86 = 619.01 mm²


Result:
───────
  ┌──────────────────────────────┐
  │  Rectangle Dimensions:       │
  │                              │
  │  Width  = 62.78 mm          │
  │  Height =  9.86 mm          │
  │  Area   = 619.01 mm²        │
  └──────────────────────────────┘


╔════════════════════════════════════════════════════════════════════════════╗
║                       KEY EQUATIONS SUMMARY                                ║
╚════════════════════════════════════════════════════════════════════════════╝

┌────────────────────────────────────────────────────────────────────────────┐
│                                                                            │
│  Epipolar Constraint:      x₂ᵀ F x₁ = 0                                   │
│                                                                            │
│  Fundamental Matrix:       Af = 0,  F = T₂ᵀ F̃ T₁                          │
│                                                                            │
│  Camera Matrices:          P₁ = [I|0],  P₂ = [[e₂]ₓF|e₂]                 │
│                                                                            │
│  Triangulation:            AX = 0  (4×4 system, solve via SVD)            │
│                                                                            │
│  3D Euclidean Distance:    d = √[(X₂-X₁)² + (Y₂-Y₁)² + (Z₂-Z₁)²]         │
│                                                                            │
│  Scale Factor:             λ = L_known / L_reconstructed                  │
│                                                                            │
│  Metric Coordinates:       X_metric = λ · X_projective                    │
│                                                                            │
│  Rectangle Width:          W = (||X₂-X₁|| + ||X₃-X₄||) / 2               │
│                                                                            │
│  Rectangle Height:         H = (||X₄-X₁|| + ||X₃-X₂||) / 2               │
│                                                                            │
│  Rectangle Area:           A = W × H                                      │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘


╔════════════════════════════════════════════════════════════════════════════╗
║                    ADVANTAGES vs LIMITATIONS                               ║
╚════════════════════════════════════════════════════════════════════════════╝

✓ ADVANTAGES:
  • No camera calibration needed
  • Works with any stereo setup
  • Only needs point correspondences
  • Flexible and easy to implement

✗ LIMITATIONS:
  • REQUIRES known reference measurement (critical!)
  • Less accurate than calibrated stereo
  • Sensitive to correspondence errors
  • Scale ambiguity must be resolved
  • Assumes rectangle is planar

ERROR SOURCES & MITIGATION:
  1. Correspondence errors    → Use RANSAC, sub-pixel refinement
  2. F matrix estimation      → Normalized 8-point, more correspondences
  3. Triangulation errors     → Larger baseline, good point distribution
  4. Reference measurement    → Accurate measurement is crucial
  5. Non-planarity            → Ensure rectangle is flat


═══════════════════════════════════════════════════════════════════════════════
                              CONCLUSION
═══════════════════════════════════════════════════════════════════════════════

  To measure a rectangular object using uncalibrated stereo:

  ① Find correspondences → Estimate F → Get P₁, P₂
  ② Triangulate reference → Compute scale λ
  ③ Triangulate rectangle corners → Apply scale
  ④ Calculate W and H from corner distances

  The KEY is scale recovery using a reference measurement!
  Without it, only relative (projective) measurements are possible.

═══════════════════════════════════════════════════════════════════════════════

